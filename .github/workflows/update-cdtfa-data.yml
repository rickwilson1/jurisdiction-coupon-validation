name: Update CDTFA Tax District Data

on:
  schedule:
    # Run every Monday at 9am UTC (1am PST)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest CDTFA data
        run: |
          echo "Downloading latest CDTFA tax district data..."
          curl -L -o CDTFA_TaxDistricts_new.gpkg \
            "https://gis.data.ca.gov/api/download/v1/items/01883a79765a4afba132ba54da408d8b/geoPackage?layers=1"

      - name: Check if file has changed
        id: check_changes
        run: |
          if [ -f "CDTFA_TaxDistricts.gpkg" ]; then
            # Compare file hashes
            OLD_HASH=$(md5sum CDTFA_TaxDistricts.gpkg | cut -d' ' -f1)
            NEW_HASH=$(md5sum CDTFA_TaxDistricts_new.gpkg | cut -d' ' -f1)
            
            if [ "$OLD_HASH" != "$NEW_HASH" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "File has changed - will update"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "File unchanged - skipping update"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "No existing file - will add"
          fi

      - name: Update file if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          mv CDTFA_TaxDistricts_new.gpkg CDTFA_TaxDistricts.gpkg
          echo "File updated"

      - name: Cleanup if unchanged
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          rm CDTFA_TaxDistricts_new.gpkg
          echo "Cleaned up temporary file"

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add CDTFA_TaxDistricts.gpkg
          git commit -m "Update CDTFA tax district data ($(date +%Y-%m-%d))"
          git push

      - name: Authenticate to Google Cloud
        if: steps.check_changes.outputs.changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        if: steps.check_changes.outputs.changed == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          gcloud run deploy tax-lookup \
            --source . \
            --region us-west1 \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --min-instances 1 \
            --project juris-coupon-valid

      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "✅ CDTFA data updated and deployed to Cloud Run"
          else
            echo "ℹ️ No changes detected - skipped deployment"
          fi
